name: CLOC Code Statistics

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  cloc:
    name: Count Lines of Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cloc
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc

      - name: Run cloc and generate reports
        run: |
          # æ‰“å°å½“å‰ç›®å½•å’Œç¯å¢ƒä¿¡æ¯
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç¯å¢ƒä¿¡æ¯: $(uname -a)"
          
          # åˆ†åˆ«æ‰§è¡Œclocå‘½ä»¤ç”Ÿæˆæ¯ç§æ ¼å¼çš„æŠ¥å‘Šï¼Œé¿å…å‚æ•°å†²çª
          echo "ç”ŸæˆCSVæŠ¥å‘Š..."
          cloc --csv --out=./cloc-report.csv --exclude-dir=.git,node_modules,__pycache__,.pytest_cache,dist,build .
          
          echo "ç”ŸæˆJSONæŠ¥å‘Š..."
          cloc --json --out=./cloc-report.json --exclude-dir=.git,node_modules,__pycache__,.pytest_cache,dist,build .
          
          echo "ç”ŸæˆMarkdownæŠ¥å‘Š..."
          cloc --md --out=./cloc-report.md --exclude-dir=.git,node_modules,__pycache__,.pytest_cache,dist,build .
          
          # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
          echo "ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la ./cloc-*

      - name: Upload cloc reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cloc-reports
          path: |
            ./cloc-report.csv
            ./cloc-report.json
            ./cloc-report.md

      - name: Generate summary table for PR comment
        if: github.event_name == 'pull_request'
        id: summary
        run: |
          python3 <<'EOF'
          import csv
          import json
          import os

          # é¦–å…ˆæ£€æŸ¥CSVæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          csv_path = './cloc-report.csv'
          if not os.path.exists(csv_path):
              print(f"è­¦å‘Š: {csv_path} æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•ä»markdownæŠ¥å‘Šç”Ÿæˆæ‘˜è¦")
              # å¦‚æœCSVæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"table<<EOF\n| è¯­è¨€ | æ–‡ä»¶æ•° | ç©ºè¡Œæ•° | æ³¨é‡Šè¡Œæ•° | ä»£ç è¡Œæ•° |\n|------|--------|--------|----------|----------|\n| æŠ¥å‘Šç”Ÿæˆä¸­ | - | - | - | - |\n| è¯¦æƒ…è¯·æŸ¥çœ‹æ„å»ºäº§ç‰©ä¸­çš„å®Œæ•´æŠ¥å‘Š | - | - | - | - |\nEOF\n")
              # å°è¯•ä»markdownæŠ¥å‘Šè¯»å–æ•°æ®
              try:
                  with open('./cloc-report.md', 'r') as md_file:
                      content = md_file.read()
                      # ç®€å•è§£æmarkdownä¸­çš„è¡¨æ ¼æ•°æ®
                      lines = content.split('\n')
                      table_start = False
                      table_data = []
                      for line in lines:
                          if '\| Language \|' in line:
                              table_start = True
                          if table_start and '\|' in line:
                              table_data.append(line)
                      # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
                      if len(table_data) > 2:  # ç¡®ä¿æœ‰è¡¨å¤´å’Œè‡³å°‘ä¸€è¡Œæ•°æ®
                          table = '\n'.join(table_data)
                          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                              f.write(f"table<<EOF\n{table}\nEOF\n")
              except Exception as e:
                  print(f"ä»markdownæŠ¥å‘Šè§£æå¤±è´¥: {e}")
          else:
              # Read CSV for summary
              summary = []
              with open(csv_path, newline='') as f:
                  reader = csv.DictReader(f)
                  for row in reader:
                      summary.append({
                          'language': row['language'],
                          'files': int(row['files']),
                          'blank': int(row['blank']),
                          'comment': int(row['comment']),
                          'code': int(row['code'])
                      })

              # Build markdown table
              headers = ['Language', 'Files', 'Blank', 'Comment', 'Code']
              rows = [
                  f"| {h} |" for h in headers
              ]
              rows.append('|' + '|'.join(['---'] * len(headers)) + '|')
              for lang in summary:
                  rows.append(
                      f"| {lang['language']} | {lang['files']} | {lang['blank']} | {lang['comment']} | {lang['code']} |"
                  )
              table = '\n'.join(rows)

              # Write to environment file for next step
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"table<<EOF\n{table}\nEOF\n")

              # Also write JSON for future extensibility
              with open('./cloc-summary.json', 'w') as f:
                  json.dump(summary, f, indent=2)
          EOF

      - name: Comment PR with cloc summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const table = `${{ steps.summary.outputs.table }}`;
            const body = `## ğŸ“Š Lines of Code Report (cloc)\n\n${table}\n\n<details><summary>Full reports</summary>\n\nDownload artifacts from the [workflow run](../actions/runs/${{ github.run_id }}).\n\n</details>`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Generate job summary
        id: job_summary
        run: |
          python3 <<'EOF'
          import json
          import os
          import sys
          import re

          # æ‰“å°æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
          print("æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦å­˜åœ¨:")
          for file in ['./cloc-report.csv', './cloc-report.json', './cloc-report.md']:
              print(f"{file}: {'å­˜åœ¨' if os.path.exists(file) else 'ä¸å­˜åœ¨'}")
          
          # åˆ›å»ºåŸºæœ¬æ‘˜è¦
          summary = "# ä»£ç ç»Ÿè®¡æ‘˜è¦\n\n"
          
          # é¦–å…ˆæ£€æŸ¥MarkdownæŠ¥å‘Šï¼Œå› ä¸ºæ—¥å¿—æ˜¾ç¤ºè¿™ä¸ªæ–‡ä»¶å­˜åœ¨
          md_file = './cloc-report.md'
          if os.path.exists(md_file):
              print(f"ä»{md_file}æå–æ‘˜è¦ä¿¡æ¯")
              try:
                  # è¯»å–MarkdownæŠ¥å‘Šå†…å®¹
                  with open(md_file, 'r', encoding='utf-8') as f:
                      md_content = f.read()
                  
                  # æå–è¡¨æ ¼æ•°æ®
                  table_match = re.search(r'\| Language \|.*?\n(?:\|---\|.*?\n)+(.*?)(?=\n\n|\Z)', md_content, re.DOTALL)
                  if table_match:
                      table_content = table_match.group(1)
                      rows = []
                      total_code = 0
                      
                      # è§£æè¡¨æ ¼è¡Œ
                      for line in table_content.strip().split('\n'):
                          parts = re.split(r'\s*\|\s*', line)
                          if len(parts) >= 6:  # ç¡®ä¿è‡³å°‘æœ‰è¯­è¨€å’Œä»£ç å­—æ®µ
                              try:
                                  lang = parts[1]
                                  files = int(parts[2]) if parts[2].isdigit() else 0
                                  blank = int(parts[3]) if parts[3].isdigit() else 0
                                  comment = int(parts[4]) if parts[4].isdigit() else 0
                                  code = int(parts[5]) if parts[5].isdigit() else 0
                                  total_code += code
                                  rows.append((lang, files, blank, comment, code))
                              except:
                                  continue
                      
                      # æŒ‰ä»£ç è¡Œæ•°æ’åº
                      sorted_rows = sorted(rows, key=lambda x: x[4], reverse=True)
                      
                      # æ ¼å¼åŒ–æ•°å­—ï¼ˆæ·»åŠ åƒä½åˆ†éš”ç¬¦ï¼‰
                      def format_num(n):
                          return f"{n:,}"
                      
                      # ç”Ÿæˆä¼˜åŒ–çš„è¡¨æ ¼
                      summary += "## é¡¹ç›®ä»£ç ç»Ÿè®¡æ¦‚è§ˆ\n\n"
                      summary += "| è¯­è¨€ | æ–‡ä»¶æ•° | ç©ºè¡Œæ•° | æ³¨é‡Šè¡Œæ•° | ä»£ç è¡Œæ•° | å æ¯” |\n"
                      summary += "|------|--------|--------|----------|----------|------|\n"
                      
                      for row in sorted_rows:
                          lang, files, blank, comment, code = row
                          percent = (code / total_code * 100) if total_code > 0 else 0
                          summary += f"| {lang} | {format_num(files)} | {format_num(blank)} | {format_num(comment)} | {format_num(code)} | {percent:.1f}% |\n"
                      
                      # è®¡ç®—æ€»è®¡
                      total_files = sum(row[1] for row in rows)
                      total_blank = sum(row[2] for row in rows)
                      total_comment = sum(row[3] for row in rows)
                      
                      # æ·»åŠ æ€»è®¡è¡Œ
                      summary += "| **æ€»è®¡** | **" + format_num(total_files) + "** | **" + format_num(total_blank) + "** | **" + format_num(total_comment) + "** | **" + format_num(total_code) + "** | **100.0%** |\n\n"
                      
                      # æ·»åŠ é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯
                      summary += "## é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯\n\n"
                      summary += f"- æ€»æ–‡ä»¶æ•°: {format_num(total_files)}\n"
                      summary += f"- æ€»è¡Œæ•°: {format_num(total_code + total_blank + total_comment)}\n"
                      summary += f"- ä»£ç è¡Œæ•°: {format_num(total_code)}\n"
                      summary += f"- æ³¨é‡Šè¡Œæ•°: {format_num(total_comment)}\n"
                      summary += f"- ç©ºè¡Œæ•°: {format_num(total_blank)}\n"
                      if total_code > 0:
                          summary += f"- æ³¨é‡Šç‡: {total_comment / total_code * 100:.1f}%\n\n"
                      else:
                          summary += f"- æ³¨é‡Šç‡: N/A\n\n"
                  else:
                      print("æ— æ³•ä»MarkdownæŠ¥å‘Šä¸­æå–è¡¨æ ¼æ•°æ®")
              except Exception as e:
                  print(f"è§£æMarkdownæŠ¥å‘Šæ—¶å‡ºé”™: {e}")
          else:
              print(f"è­¦å‘Š: {md_file} æ–‡ä»¶ä¸å­˜åœ¨")
          
          # æ·»åŠ å®Œæ•´æŠ¥å‘Šä¿¡æ¯
          summary += "## å®Œæ•´æŠ¥å‘Š\n\n"
          summary += "å®Œæ•´çš„ä»£ç ç»Ÿè®¡æŠ¥å‘Šå¯åœ¨æ„å»ºäº§ç‰©ä¸­ä¸‹è½½ã€‚äº§ç‰©åªæœ‰mdã€‚\n"
          
          # è¾“å‡ºåˆ°GitHub Step Summary
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'w', encoding='utf-8') as f:
              f.write(summary)
          
          print("æ‘˜è¦ç”Ÿæˆå®Œæˆ")
          EOF
