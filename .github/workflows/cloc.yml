name: CLOC Code Statistics

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  cloc:
    name: Count Lines of Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cloc
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc

      - name: Run cloc and generate reports
        run: |
          # æ‰“å°å½“å‰ç›®å½•å’Œç¯å¢ƒä¿¡æ¯
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç¯å¢ƒä¿¡æ¯: $(uname -a)"
          
          # æ‰§è¡Œclocå‘½ä»¤å¹¶ç¡®ä¿åœ¨å½“å‰ç›®å½•ç”ŸæˆæŠ¥å‘Š
          cloc \
            --csv \
            --out=./cloc-report.csv \
            --json \
            --out=./cloc-report.json \
            --md \
            --out=./cloc-report.md \
            --exclude-dir=.git,node_modules,__pycache__,.pytest_cache,dist,build \
            .
          
          # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
          echo "ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la ./cloc-*

      - name: Upload cloc reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cloc-reports
          path: |
            ./cloc-report.csv
            ./cloc-report.json
            ./cloc-report.md

      - name: Generate summary table for PR comment
        if: github.event_name == 'pull_request'
        id: summary
        run: |
          python3 <<'EOF'
          import csv
          import json
          import os

          # Read CSV for summary
          summary = []
          with open('cloc-report.csv', newline='') as f:
              reader = csv.DictReader(f)
              for row in reader:
                  summary.append({
                      'language': row['language'],
                      'files': int(row['files']),
                      'blank': int(row['blank']),
                      'comment': int(row['comment']),
                      'code': int(row['code'])
                  })

          # Build markdown table
          headers = ['Language', 'Files', 'Blank', 'Comment', 'Code']
          rows = [
              f"| {h} |" for h in headers
          ]
          rows.append('|' + '|'.join(['---'] * len(headers)) + '|')
          for lang in summary:
              rows.append(
                  f"| {lang['language']} | {lang['files']} | {lang['blank']} | {lang['comment']} | {lang['code']} |"
              )
          table = '\n'.join(rows)

          # Write to environment file for next step
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"table<<EOF\n{table}\nEOF\n")

          # Also write JSON for future extensibility
          with open('cloc-summary.json', 'w') as f:
              json.dump(summary, f, indent=2)
          EOF

      - name: Comment PR with cloc summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const table = `${{ steps.summary.outputs.table }}`;
            const body = `## ğŸ“Š Lines of Code Report (cloc)\n\n${table}\n\n<details><summary>Full reports</summary>\n\nDownload artifacts from the [workflow run](../actions/runs/${{ github.run_id }}).\n\n</details>`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Generate job summary
        run: |
          # æ·»åŠ æ ‡é¢˜
          echo "## ğŸ“Š CLOC Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # éªŒè¯æŠ¥å‘Šæ–‡ä»¶å­˜åœ¨
          if [ ! -f "./cloc-report.md" ]; then
            echo "è­¦å‘Š: cloc-report.md æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆç”Ÿæˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥ cloc å‘½ä»¤çš„æ‰§è¡Œæƒ…å†µã€‚" >> $GITHUB_STEP_SUMMARY
          else
            # é¦–å…ˆæ£€æŸ¥CSVæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ä½¿ç”¨ä¼˜åŒ–çš„è¡¨æ ¼
            if [ -f "./cloc-report.csv" ]; then
              echo "ä½¿ç”¨CSVæ•°æ®ç”Ÿæˆä¼˜åŒ–è¡¨æ ¼..."
              
              # ç”Ÿæˆä¼˜åŒ–çš„è¡¨æ ¼æ˜¾ç¤º
              python3 <<'EOF'
              import csv
              import os
              
              try:
                  # è¯»å–CSVæ•°æ®
                  summary = []
                  with open('./cloc-report.csv', newline='') as f:
                      reader = csv.DictReader(f)
                      for row in reader:
                          summary.append({
                              'language': row['language'],
                              'files': int(row['files']),
                              'blank': int(row['blank']),
                              'comment': int(row['comment']),
                              'code': int(row['code'])
                          })
                  
                  # æŒ‰ä»£ç è¡Œæ•°é™åºæ’åº
                  summary.sort(key=lambda x: x['code'], reverse=True)
                  
                  # è®¡ç®—æ€»è®¡
                  total_files = sum(lang['files'] for lang in summary)
                  total_blank = sum(lang['blank'] for lang in summary)
                  total_comment = sum(lang['comment'] for lang in summary)
                  total_code = sum(lang['code'] for lang in summary)
                  
                  # å†™å…¥ä¼˜åŒ–çš„è¡¨æ ¼åˆ°å·¥ä½œæµæ‘˜è¦
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write("### ä»£ç ç»Ÿè®¡æ‘˜è¦\n\n")
                      f.write("| è¯­è¨€ | æ–‡ä»¶æ•° | ç©ºè¡Œæ•° | æ³¨é‡Šè¡Œæ•° | ä»£ç è¡Œæ•° | å æ¯” |\n")
                      f.write("|------|--------|--------|----------|----------|------|\n")
                      
                      # å†™å…¥æ¯ä¸ªè¯­è¨€çš„æ•°æ®
                      for lang in summary:
                          percentage = (lang['code'] / total_code * 100) if total_code > 0 else 0
                          f.write(f"| {lang['language']} | {lang['files']:,} | {lang['blank']:,} | {lang['comment']:,} | {lang['code']:,} | {percentage:.1f}% |\n")
                      
                      # å†™å…¥æ€»è®¡è¡Œ
                      f.write("| **æ€»è®¡** | **{:,}** | **{:,}** | **{:,}** | **{:,}** | **100.0%** |\n\n".format(total_files, total_blank, total_comment, total_code))
                      
                      # æ·»åŠ ä¸€äº›é¢å¤–çš„ç»Ÿè®¡ä¿¡æ¯
                      f.write("### é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯\n\n")
                      f.write(f"- **æ€»æ–‡ä»¶æ•°**: {total_files:,}\n")
                      f.write(f"- **æ€»ä»£ç è¡Œæ•°**: {total_code:,}\n")
                      if (total_code + total_comment) > 0:
                          f.write(f"- **æ³¨é‡Šç‡**: {total_comment / (total_code + total_comment) * 100:.1f}%\n")
                      if (total_code + total_blank) > 0:
                          f.write(f"- **ç©ºç™½ç‡**: {total_blank / (total_code + total_blank) * 100:.1f}%\n\n")
              except Exception as e:
                  # å¦‚æœå‡ºç°é”™è¯¯ï¼Œå†™å…¥é”™è¯¯ä¿¡æ¯å¹¶ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write(f"### ç”Ÿæˆç»Ÿè®¡æ—¶å‡ºé”™: {str(e)}\n\n")
                      f.write("å°†ä½¿ç”¨åŸå§‹æŠ¥å‘Šå†…å®¹...\n\n")
                      # å°è¯•è¯»å–åŸå§‹çš„markdownæŠ¥å‘Š
                      try:
                          with open('./cloc-report.md', 'r') as md_file:
                              f.write(md_file.read() + "\n\n")
                      except:
                          pass
              
          EOF
            else:
              # å¦‚æœCSVæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨åŸå§‹çš„markdownæŠ¥å‘Š
              echo "CSVæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨åŸå§‹markdownæŠ¥å‘Šå†…å®¹" 
              cat ./cloc-report.md >> $GITHUB_STEP_SUMMARY
            fi
            
            # æ·»åŠ å®Œæ•´æŠ¥å‘Šçš„å¼•ç”¨
            echo "### å®Œæ•´æŠ¥å‘Š\n\n" >> $GITHUB_STEP_SUMMARY
            echo "å®Œæ•´çš„ä»£ç ç»Ÿè®¡æŠ¥å‘Šå¯åœ¨[æ„å»ºäº§ç‰©](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ä¸­ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
