name: CLOC Code Statistics

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  cloc:
    name: Count Lines of Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cloc
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc

      - name: Run cloc and generate reports
        run: |
          # æ‰“å°å½“å‰ç›®å½•å’Œç¯å¢ƒä¿¡æ¯
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç¯å¢ƒä¿¡æ¯: $(uname -a)"
          
          # åˆ†åˆ«æ‰§è¡Œclocå‘½ä»¤ç”Ÿæˆæ¯ç§æ ¼å¼çš„æŠ¥å‘Šï¼Œé¿å…å‚æ•°å†²çª
          echo "ç”ŸæˆCSVæŠ¥å‘Š..."
          cloc --csv --out=./cloc-report.csv --exclude-dir=.git,node_modules,__pycache__,.pytest_cache,dist,build .
          
          echo "ç”ŸæˆJSONæŠ¥å‘Š..."
          cloc --json --out=./cloc-report.json --exclude-dir=.git,node_modules,__pycache__,.pytest_cache,dist,build .
          
          echo "ç”ŸæˆMarkdownæŠ¥å‘Š..."
          cloc --md --out=./cloc-report.md --exclude-dir=.git,node_modules,__pycache__,.pytest_cache,dist,build .
          
          # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
          echo "ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la ./cloc-*

      - name: Upload cloc reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cloc-reports
          path: |
            ./cloc-report.csv
            ./cloc-report.json
            ./cloc-report.md

      - name: Generate summary table for PR comment
        if: github.event_name == 'pull_request'
        id: summary
        run: |
          # æ‰“å°è°ƒè¯•ä¿¡æ¯
          echo "===== PRè¯„è®ºç”Ÿæˆè°ƒè¯•ä¿¡æ¯ ===="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la ./cloc-* 2>/dev/null || echo "æœªæ‰¾åˆ°clocæŠ¥å‘Šæ–‡ä»¶"
          
          python3 <<'EOF'
          import os
          import sys
          import re

          print("å¼€å§‹ç”ŸæˆPRè¯„è®ºæ‘˜è¦...")

          # é¦–å…ˆæ£€æŸ¥CSVæ–‡ä»¶ï¼Œè¿™æ˜¯æœ€å¯é çš„æ•°æ®æº
          csv_file = './cloc-report.csv'
          table_content = ""
          
          if os.path.exists(csv_file):
              print(f"ä»{csv_file}è¯»å–æ•°æ®ç”Ÿæˆè¡¨æ ¼")
              try:
                  # ä½¿ç”¨ç®€åŒ–çš„CSVè¯»å–æ–¹å¼
                  with open(csv_file, 'r', encoding='utf-8') as f:
                      lines = f.readlines()
                      
                  if len(lines) > 1:
                      # æå–æ ‡é¢˜è¡Œå’Œæ•°æ®è¡Œ
                      headers = lines[0].strip().split(',')
                      data_lines = lines[1:]
                      
                      # ç¡®ä¿æœ‰æ­£ç¡®çš„åˆ—
                      if len(headers) >= 6:
                          # åˆ›å»ºè¡¨æ ¼å¤´éƒ¨ï¼ˆä¸­æ–‡ï¼‰
                          table_content = "| è¯­è¨€ | æ–‡ä»¶æ•° | ç©ºè¡Œæ•° | æ³¨é‡Šè¡Œæ•° | ä»£ç è¡Œæ•° | å æ¯” |\n"
                          table_content += "|------|--------|--------|----------|----------|------|\n"
                          
                          # è§£ææ•°æ®å¹¶è®¡ç®—æ€»è®¡
                          rows = []
                          total_code = 0
                          
                          for line in data_lines:
                              try:
                                  # ç®€å•çš„CSVè§£æ
                                  parts = re.split(r',(?=(?:[^"]*"[^"]*")*[^"]*$)', line.strip())
                                  if len(parts) >= 5:
                                      # æ ¹æ®å®é™…CSVæ ¼å¼ï¼šfiles, language, blank, comment, code
                                      files = int(parts[0]) if parts[0].isdigit() else 0
                                      lang = parts[1].strip('"') if parts[1].startswith('"') else parts[1]
                                      # è·³è¿‡SUMè¡Œ
                                      if lang == 'SUM':
                                          continue
                                      blank = int(parts[2]) if parts[2].isdigit() else 0
                                      comment = int(parts[3]) if parts[3].isdigit() else 0
                                      code = int(parts[4]) if parts[4].isdigit() else 0
                                      rows.append((lang, files, blank, comment, code))
                                      total_code += code
                              except Exception as e:
                                  print(f"è§£æè¡Œæ—¶å‡ºé”™: {line}, é”™è¯¯: {e}")
                          
                          # æŒ‰ä»£ç è¡Œæ•°æ’åº
                          rows.sort(key=lambda x: x[4], reverse=True)
                          
                          # æ ¼å¼åŒ–æ•°å­—
                          def format_num(n):
                              return f"{n:,}"
                          
                          # ç”Ÿæˆè¡¨æ ¼è¡Œ
                          for row in rows:
                              lang, files, blank, comment, code = row
                              percent = (code / total_code * 100) if total_code > 0 else 0
                              table_content += f"| {lang} | {format_num(files)} | {format_num(blank)} | {format_num(comment)} | {format_num(code)} | {percent:.1f}% |\n"
                          
                          # è®¡ç®—æ€»è®¡
                          total_files = sum(row[1] for row in rows)
                          total_blank = sum(row[2] for row in rows)
                          total_comment = sum(row[3] for row in rows)
                          
                          # æ·»åŠ æ€»è®¡è¡Œ
                          table_content += "| **æ€»è®¡** | **" + format_num(total_files) + "** | **" + format_num(total_blank) + "** | **" + format_num(total_comment) + "** | **" + format_num(total_code) + "** | **100.0%** |\n"
              except Exception as e:
                  print(f"è¯»å–CSVæ–‡ä»¶æ—¶å‡ºé”™: {e}")
          
          # å¦‚æœCSVæ–‡ä»¶è¯»å–å¤±è´¥æˆ–æ²¡æœ‰ç”Ÿæˆè¡¨æ ¼ï¼Œå°è¯•ä»Markdownæ–‡ä»¶è·å–
          md_file = './cloc-report.md'
          if not table_content and os.path.exists(md_file):
              print(f"ä»{md_file}è¯»å–æ•°æ®ç”Ÿæˆè¡¨æ ¼")
              try:
                  with open(md_file, 'r', encoding='utf-8') as f:
                      md_content = f.read()
                  
                  # ç›´æ¥æŸ¥æ‰¾è¡¨æ ¼éƒ¨åˆ†
                  if "| Language |" in md_content:
                      lines = md_content.split('\n')
                      table_start = False
                      table_lines = []
                      
                      for line in lines:
                          if "| Language |" in line:
                              table_start = True
                              # æ·»åŠ ä¸­æ–‡è¡¨å¤´
                              table_lines.append("| è¯­è¨€ | æ–‡ä»¶æ•° | ç©ºè¡Œæ•° | æ³¨é‡Šè¡Œæ•° | ä»£ç è¡Œæ•° |\n")
                              table_lines.append("|------|--------|--------|----------|----------|\n")
                          elif table_start and "|" in line:
                              # è·³è¿‡åˆ†éš”è¡Œ
                              if "---" in line:
                                  continue
                              # æ·»åŠ æ•°æ®è¡Œ
                              table_lines.append(line + "\n")
                          elif table_start and not line.strip():
                              break
                      
                      if len(table_lines) > 2:
                          table_content = ''.join(table_lines)
              except Exception as e:
                  print(f"è¯»å–Markdownæ–‡ä»¶æ—¶å‡ºé”™: {e}")
          
          # å¦‚æœè¿˜æ²¡æœ‰è¡¨æ ¼å†…å®¹ï¼Œä½¿ç”¨å¤‡ç”¨è¡¨æ ¼
          if not table_content:
              print("ä½¿ç”¨å¤‡ç”¨è¡¨æ ¼æ¨¡æ¿")
              table_content = "| è¯­è¨€ | æ–‡ä»¶æ•° | ç©ºè¡Œæ•° | æ³¨é‡Šè¡Œæ•° | ä»£ç è¡Œæ•° |\n"
              table_content += "|------|--------|--------|----------|----------|\n"
              table_content += "| æŠ¥å‘Šç”Ÿæˆä¸­ | - | - | - | - |\n"
              table_content += "| è¯¦æƒ…è¯·æŸ¥çœ‹æ„å»ºäº§ç‰©ä¸­çš„å®Œæ•´æŠ¥å‘Š | - | - | - | - |\n"
          
          # å†™å…¥è¡¨æ ¼å†…å®¹åˆ°ç¯å¢ƒå˜é‡
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"table<<EOF\n{table_content}\nEOF\n")
          
          print("PRè¯„è®ºè¡¨æ ¼ç”Ÿæˆå®Œæˆ")
          # æ‰“å°è¡¨æ ¼å†…å®¹ä»¥ä¾¿è°ƒè¯•
          print("\nè¡¨æ ¼å†…å®¹é¢„è§ˆ:")
          print(table_content[:500] + "..." if len(table_content) > 500 else table_content)
          EOF

      - name: Comment PR with cloc summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const table = `${{ steps.summary.outputs.table }}`;
            const body = `## ğŸ“Š Lines of Code Report (cloc)\n\n${table}\n\n<details><summary>Full reports</summary>\n\nDownload artifacts from the [workflow run](../actions/runs/${{ github.run_id }}).\n\n</details>`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Generate job summary
        run: |
          # æ‰“å°è°ƒè¯•ä¿¡æ¯
          echo "===== ä»»åŠ¡æ‘˜è¦ç”Ÿæˆè°ƒè¯•ä¿¡æ¯ ===="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la ./cloc-* 2>/dev/null || echo "æœªæ‰¾åˆ°clocæŠ¥å‘Šæ–‡ä»¶"
          
          python3 <<'EOF'
          import os
          import re
          
          print("å¼€å§‹ç”ŸæˆGitHub Job Summary...")
          
          # åˆ›å»ºæ‘˜è¦æ–‡ä»¶è·¯å¾„
          summary_path = os.environ.get('GITHUB_STEP_SUMMARY', '')
          if not summary_path:
              print("è­¦å‘Š: GITHUB_STEP_SUMMARY ç¯å¢ƒå˜é‡æœªè®¾ç½®")
              # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä½œä¸ºæ›¿ä»£
              summary_path = './job-summary.md'
          
          # ç”Ÿæˆæ‘˜è¦å†…å®¹
          summary_content = "# ä»£ç ç»Ÿè®¡æŠ¥å‘Š\n\n"
          
          # é¦–å…ˆæ£€æŸ¥CSVæ–‡ä»¶ï¼Œè¿™æ˜¯æœ€å¯é çš„æ•°æ®æº
          csv_file = './cloc-report.csv'
          table_content = ""
          
          if os.path.exists(csv_file):
              print(f"ä»{csv_file}è¯»å–æ•°æ®ç”Ÿæˆè¡¨æ ¼")
              try:
                  # ä½¿ç”¨ç®€åŒ–çš„CSVè¯»å–æ–¹å¼
                  with open(csv_file, 'r', encoding='utf-8') as f:
                      lines = f.readlines()
                      
                  if len(lines) > 1:
                      # æå–æ ‡é¢˜è¡Œå’Œæ•°æ®è¡Œ
                      headers = lines[0].strip().split(',')
                      data_lines = lines[1:]
                      
                      # ç¡®ä¿æœ‰æ­£ç¡®çš„åˆ—
                      if len(headers) >= 6:
                          # åˆ›å»ºè¡¨æ ¼å¤´éƒ¨ï¼ˆä¸­æ–‡ï¼‰
                          table_content = "## ä»£ç ç»Ÿè®¡æ‘˜è¦\n\n"
                          table_content += "| è¯­è¨€ | æ–‡ä»¶æ•° | ç©ºè¡Œæ•° | æ³¨é‡Šè¡Œæ•° | ä»£ç è¡Œæ•° | å æ¯” |\n"
                          table_content += "|------|--------|--------|----------|----------|------|\n"
                          
                          # è§£ææ•°æ®å¹¶è®¡ç®—æ€»è®¡
                          rows = []
                          total_code = 0
                          
                          for line in data_lines:
                              try:
                                  # ç®€å•çš„CSVè§£æ
                                  parts = re.split(r',(?=(?:[^"]*"[^"]*")*[^"]*$)', line.strip())
                                  if len(parts) >= 5:
                                      # æ ¹æ®å®é™…CSVæ ¼å¼ï¼šfiles, language, blank, comment, code
                                      files = int(parts[0]) if parts[0].isdigit() else 0
                                      lang = parts[1].strip('"') if parts[1].startswith('"') else parts[1]
                                      # è·³è¿‡SUMè¡Œ
                                      if lang == 'SUM':
                                          continue
                                      blank = int(parts[2]) if parts[2].isdigit() else 0
                                      comment = int(parts[3]) if parts[3].isdigit() else 0
                                      code = int(parts[4]) if parts[4].isdigit() else 0
                                      rows.append((lang, files, blank, comment, code))
                                      total_code += code
                              except Exception as e:
                                  print(f"è§£æè¡Œæ—¶å‡ºé”™: {line}, é”™è¯¯: {e}")
                          
                          # æŒ‰ä»£ç è¡Œæ•°æ’åº
                          rows.sort(key=lambda x: x[4], reverse=True)
                          
                          # æ ¼å¼åŒ–æ•°å­—
                          def format_num(n):
                              return f"{n:,}"
                          
                          # ç”Ÿæˆè¡¨æ ¼è¡Œ
                          for row in rows:
                              lang, files, blank, comment, code = row
                              percent = (code / total_code * 100) if total_code > 0 else 0
                              table_content += f"| {lang} | {format_num(files)} | {format_num(blank)} | {format_num(comment)} | {format_num(code)} | {percent:.1f}% |\n"
                          
                          # è®¡ç®—æ€»è®¡
                          total_files = sum(row[1] for row in rows)
                          total_blank = sum(row[2] for row in rows)
                          total_comment = sum(row[3] for row in rows)
                          
                          # æ·»åŠ æ€»è®¡è¡Œ
                          table_content += "| **æ€»è®¡** | **" + format_num(total_files) + "** | **" + format_num(total_blank) + "** | **" + format_num(total_comment) + "** | **" + format_num(total_code) + "** | **100.0%** |\n"
              except Exception as e:
                  print(f"è¯»å–CSVæ–‡ä»¶æ—¶å‡ºé”™: {e}")
          
          # å¦‚æœCSVæ–‡ä»¶è¯»å–å¤±è´¥æˆ–æ²¡æœ‰ç”Ÿæˆè¡¨æ ¼ï¼Œå°è¯•ä»Markdownæ–‡ä»¶è·å–
          md_file = './cloc-report.md'
          if not table_content and os.path.exists(md_file):
              print(f"ä»{md_file}è¯»å–æ•°æ®ç”Ÿæˆè¡¨æ ¼")
              try:
                  with open(md_file, 'r', encoding='utf-8') as f:
                      md_content = f.read()
                  
                  # ç›´æ¥æŸ¥æ‰¾è¡¨æ ¼éƒ¨åˆ†å¹¶å¤åˆ¶
                  if "| Language |" in md_content:
                      lines = md_content.split('\n')
                      table_start = False
                      table_lines = []
                      
                      # æ·»åŠ ä¸­æ–‡è¡¨å¤´
                      table_lines.append("## ä»£ç ç»Ÿè®¡æ‘˜è¦\n\n")
                      table_lines.append("| è¯­è¨€ | æ–‡ä»¶æ•° | ç©ºè¡Œæ•° | æ³¨é‡Šè¡Œæ•° | ä»£ç è¡Œæ•° |\n")
                      table_lines.append("|------|--------|--------|----------|----------|\n")
                      
                      for line in lines:
                          if "| Language |" in line:
                              table_start = True
                          elif table_start and "|" in line:
                              # è·³è¿‡åˆ†éš”è¡Œ
                              if "---" in line:
                                  continue
                              # æ·»åŠ æ•°æ®è¡Œ
                              table_lines.append(line + "\n")
                          elif table_start and not line.strip():
                              break
                      
                      if len(table_lines) > 3:  # ç¡®ä¿æœ‰è¡¨å¤´å’Œè‡³å°‘ä¸€è¡Œæ•°æ®
                          table_content = ''.join(table_lines)
              except Exception as e:
                  print(f"è¯»å–Markdownæ–‡ä»¶æ—¶å‡ºé”™: {e}")
          
          # å¦‚æœè¿˜æ²¡æœ‰è¡¨æ ¼å†…å®¹ï¼Œä½¿ç”¨å¤‡ç”¨è¡¨æ ¼
          if not table_content:
              print("ä½¿ç”¨å¤‡ç”¨è¡¨æ ¼æ¨¡æ¿")
              table_content = "## ä»£ç ç»Ÿè®¡æ‘˜è¦\n\n"
              table_content += "| è¯­è¨€ | æ–‡ä»¶æ•° | ç©ºè¡Œæ•° | æ³¨é‡Šè¡Œæ•° | ä»£ç è¡Œæ•° |\n"
              table_content += "|------|--------|--------|----------|----------|\n"
              table_content += "| æŠ¥å‘Šç”Ÿæˆä¸­ | - | - | - | - |\n"
              table_content += "| è¯¦æƒ…è¯·æŸ¥çœ‹æ„å»ºäº§ç‰©ä¸­çš„å®Œæ•´æŠ¥å‘Š | - | - | - | - |\n"
          
          # æ·»åŠ é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯
          project_info = "## é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯\n\n"
          project_info += "- **ä»£ç ä»“åº“**: " + os.environ.get('GITHUB_REPOSITORY', 'æœªçŸ¥') + "\n"
          project_info += "- **åˆ†æ”¯**: " + os.environ.get('GITHUB_REF_NAME', 'æœªçŸ¥') + "\n"
          project_info += "- **æäº¤**: " + os.environ.get('GITHUB_SHA', 'æœªçŸ¥')[:7] + "\n\n"
          
          # æ·»åŠ å®Œæ•´æŠ¥å‘Šå¼•ç”¨
          complete_report = "## å®Œæ•´æŠ¥å‘Š\n\n"
          complete_report += "å®Œæ•´çš„ä»£ç ç»Ÿè®¡æŠ¥å‘Šå¯åœ¨æ„å»ºäº§ç‰©ä¸­ä¸‹è½½ã€‚äº§ç‰©åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š\n"
          complete_report += "- cloc-report.md (Markdownæ ¼å¼)\n"
          complete_report += "- cloc-report.csv (CSVæ ¼å¼)\n"
          complete_report += "- cloc-report.json (JSONæ ¼å¼)\n\n"
          
          # ç»„åˆæ‰€æœ‰å†…å®¹
          summary_content += table_content + "\n\n" + project_info + complete_report
          
          # å†™å…¥æ‘˜è¦æ–‡ä»¶
          try:
              with open(summary_path, 'w', encoding='utf-8') as f:
                  f.write(summary_content)
              print(f"æˆåŠŸå†™å…¥æ‘˜è¦åˆ° {summary_path}")
          except Exception as e:
              print(f"å†™å…¥æ‘˜è¦æ–‡ä»¶å¤±è´¥: {e}")
              # ä½œä¸ºå¤‡ç”¨ï¼Œæ‰“å°åˆ°æ§åˆ¶å°
              print("\næ‘˜è¦å†…å®¹:")
              print(summary_content)
          
          # æ‰“å°æ‘˜è¦å†…å®¹ä»¥ä¾¿è°ƒè¯•
          print("\næ‘˜è¦å†…å®¹é¢„è§ˆ:")
          print(summary_content[:1000] + "..." if len(summary_content) > 1000 else summary_content)
          EOF
