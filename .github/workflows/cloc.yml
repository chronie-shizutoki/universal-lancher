name: CLOC Code Statistics

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  cloc:
    name: Count Lines of Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cloc
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc

      - name: Run cloc and generate reports
        run: |
          cloc \
            --csv \
            --out=cloc-report.csv \
            --json \
            --out=cloc-report.json \
            --md \
            --out=cloc-report.md \
            --exclude-dir=.git,node_modules,__pycache__,.pytest_cache,dist,build \
            .

      - name: Upload cloc reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cloc-reports
          path: |
            cloc-report.csv
            cloc-report.json
            cloc-report.md

      - name: Generate summary table for PR comment
        if: github.event_name == 'pull_request'
        id: summary
        run: |
          python3 <<'EOF'
          import csv
          import json
          import os

          # Read CSV for summary
          summary = []
          with open('cloc-report.csv', newline='') as f:
              reader = csv.DictReader(f)
              for row in reader:
                  summary.append({
                      'language': row['language'],
                      'files': int(row['files']),
                      'blank': int(row['blank']),
                      'comment': int(row['comment']),
                      'code': int(row['code'])
                  })

          # Build markdown table
          headers = ['Language', 'Files', 'Blank', 'Comment', 'Code']
          rows = [
              f"| {h} |" for h in headers
          ]
          rows.append('|' + '|'.join(['---'] * len(headers)) + '|')
          for lang in summary:
              rows.append(
                  f"| {lang['language']} | {lang['files']} | {lang['blank']} | {lang['comment']} | {lang['code']} |"
              )
          table = '\n'.join(rows)

          # Write to environment file for next step
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"table<<EOF\n{table}\nEOF\n")

          # Also write JSON for future extensibility
          with open('cloc-summary.json', 'w') as f:
              json.dump(summary, f, indent=2)
          EOF

      - name: Comment PR with cloc summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const table = `${{ steps.summary.outputs.table }}`;
            const body = `## üìä Lines of Code Report (cloc)\n\n${table}\n\n<details><summary>Full reports</summary>\n\nDownload artifacts from the [workflow run](../actions/runs/${{ github.run_id }}).\n\n</details>`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Generate job summary
        run: |
          # Ê∑ªÂä†Ê†áÈ¢ò
          echo "## üìä CLOC Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ÁîüÊàê‰ºòÂåñÁöÑË°®Ê†ºÊòæÁ§∫
          python3 <<'EOF'
          import csv
          import os
          
          # ËØªÂèñCSVÊï∞ÊçÆ
          summary = []
          with open('cloc-report.csv', newline='') as f:
              reader = csv.DictReader(f)
              for row in reader:
                  summary.append({
                      'language': row['language'],
                      'files': int(row['files']),
                      'blank': int(row['blank']),
                      'comment': int(row['comment']),
                      'code': int(row['code'])
                  })
          
          # Êåâ‰ª£Á†ÅË°åÊï∞ÈôçÂ∫èÊéíÂ∫è
          summary.sort(key=lambda x: x['code'], reverse=True)
          
          # ËÆ°ÁÆóÊÄªËÆ°
          total_files = sum(lang['files'] for lang in summary)
          total_blank = sum(lang['blank'] for lang in summary)
          total_comment = sum(lang['comment'] for lang in summary)
          total_code = sum(lang['code'] for lang in summary)
          
          # ÂÜôÂÖ•‰ºòÂåñÁöÑË°®Ê†ºÂà∞Â∑•‰ΩúÊµÅÊëòË¶Å
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write("### ‰ª£Á†ÅÁªüËÆ°ÊëòË¶Å\n\n")
              f.write("| ËØ≠Ë®Ä | Êñá‰ª∂Êï∞ | Á©∫Ë°åÊï∞ | Ê≥®ÈáäË°åÊï∞ | ‰ª£Á†ÅË°åÊï∞ | Âç†ÊØî |\n")
              f.write("|------|--------|--------|----------|----------|------|\n")
              
              # ÂÜôÂÖ•ÊØè‰∏™ËØ≠Ë®ÄÁöÑÊï∞ÊçÆ
              for lang in summary:
                  percentage = (lang['code'] / total_code * 100) if total_code > 0 else 0
                  f.write(f"| {lang['language']} | {lang['files']:,} | {lang['blank']:,} | {lang['comment']:,} | {lang['code']:,} | {percentage:.1f}% |\n")
              
              # ÂÜôÂÖ•ÊÄªËÆ°Ë°å
              f.write("| **ÊÄªËÆ°** | **{:,}** | **{:,}** | **{:,}** | **{:,}** | **100.0%** |\n\n".format(total_files, total_blank, total_comment, total_code))
              
              # Ê∑ªÂä†‰∏Ä‰∫õÈ¢ùÂ§ñÁöÑÁªüËÆ°‰ø°ÊÅØ
              f.write("### È°πÁõÆÁªüËÆ°‰ø°ÊÅØ\n\n")
              f.write(f"- **ÊÄªÊñá‰ª∂Êï∞**: {total_files:,}\n")
              f.write(f"- **ÊÄª‰ª£Á†ÅË°åÊï∞**: {total_code:,}\n")
              f.write(f"- **Ê≥®ÈáäÁéá**: {total_comment / (total_code + total_comment) * 100:.1f}%\n")
              f.write(f"- **Á©∫ÁôΩÁéá**: {total_blank / (total_code + total_blank) * 100:.1f}%\n\n")
          EOF
          
          # Ê∑ªÂä†ÂÆåÊï¥Êä•ÂëäÁöÑÂºïÁî®
          echo "### ÂÆåÊï¥Êä•Âëä\n\n" >> $GITHUB_STEP_SUMMARY
          echo "ÂÆåÊï¥ÁöÑ‰ª£Á†ÅÁªüËÆ°Êä•ÂëäÂèØÂú®[ÊûÑÂª∫‰∫ßÁâ©](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})‰∏≠‰∏ãËΩΩ„ÄÇ" >> $GITHUB_STEP_SUMMARY
