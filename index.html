<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <title>统一启动器</title>
  <meta name="description" content="统一启动器 - 快速访问各种服务">
  <meta name="theme-color" content="#667eea">
  <link rel="manifest" href="manifest.json">
  <!-- iOS PWA支持 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="统一启动器">
  <link rel="apple-touch-icon" href="icons/icon.svg">
  <!-- Android PWA增强支持 -->
  <link rel="icon" href="icons/icon.svg" type="image/svg+xml">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="统一启动器">
</head>
<body>
<div class="welcome">
  <h1>你好，欢迎来到我们的统一启动器！<br>Hello, welcome to our universal launcher!</h1>
  <p>请选择一个服务开始：<br>Choose a service to begin:</p>
</div>

<div class="button-group main">
  <a class="btn primary" href="http://192.168.0.197:3010">记账Homemoney</a>
  <a class="btn primary" href="http://192.168.0.197:3100">金流Chrysorrhoe</a>
  <a class="btn primary" href="http://192.168.0.197:5000">库存Inventory</a>
</div>

<div class="extras">
  <h2>其他临时服务<br>Other temporary services</h2>
  <div class="button-group secondary">
    <a class="btn secondary" href="http://192.168.0.197:8200">收入Income Tracker</a>
    <a class="btn secondary" href="http://192.168.0.197:8100">金流Chrysorrhoe CDK Recharge充值</a>
  </div>
</div>

<div class="compatibility">
  <button class="btn primary" id="check-compatibility" onclick="window.location.href='./component/compatibility-check/browser.html'">检查兼容性<br>Check your browser compatibility</button>
  <button class="btn primary" id="rate" onclick="window.location.href='./component/exchange-rate/rate.html'">汇率计算器<br>Exchange Rate Calculator</button>
</div>

<div>
  <br>
  <small id="user-agent"></small>
</div>

<script>
  document.getElementById('user-agent').textContent = navigator.userAgent;
</script>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #f5f7fa;
    color: #333;
    margin: 0;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    text-align: center;
  }

  .welcome h1 {
    margin: 0 0 .5rem;
    font-weight: 600;
    color: #2c3e50;
    text-align: center;
  }

  .welcome p {
    margin: 0 0 2rem;
    font-size: 1.1rem;
    color: #555;
    text-align: center;
  }

  .button-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 2.5rem;
  }

  .btn {
    padding: .9rem 1.8rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: transform .15s ease, box-shadow .15s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, .08);
  }

  .btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
  }

  .btn.secondary {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    color: #333;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, .12);
  }

  .extras h2 {
    font-size: 1.25rem;
    margin: 0 0 1rem;
    color: #2c3e50;
    text-align: center;
  }

  @media (prefers-color-scheme: dark) {
    body {
      background: #2c3e50;
      color: #fff;
    }

    .welcome h1, .extras h2 {
      color: #fff;
    }

    .welcome p {
      color: #aaa;
    }

    .btn.primary {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .btn.secondary {
      background: #aaa;
      color: #fff;
    }
  }
</style>

<!-- PWA安装提示 -->
<div id="installPrompt" class="install-prompt" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--install-bg, #2c3e50); color: var(--install-text, #fff); padding: 1.5rem; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 9999; min-width: 300px; max-width: 90vw; transition: background 0.3s ease, color 0.3s ease;">
  <h3 style="margin: 0 0 10px 0; font-size: 1.2rem;">安装统一启动器</h3>
  <p style="margin: 0 0 15px 0; opacity: 0.9;">将此应用安装到您的桌面或移动设备，获得更好的体验</p>
  <div style="display: flex; gap: 12px; justify-content: flex-end;">
    <button id="closeInstallBtn" style="background: transparent; color: inherit; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.2s;">稍后</button>
    <button id="installBtn" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">立即安装</button>
  </div>
</div>

<!-- Safari安装指南固定显示在底部 -->
<div class="safari-install-guide" style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--install-bg, #2c3e50); color: var(--install-text, #fff); padding: 1rem; text-align: center; font-size: 0.9rem; z-index: 999; border-top: 1px solid rgba(255,255,255,0.1);">
  <p style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
    <span>Safari用户: 点击分享按钮 → 添加到主屏幕</span>
  </p>
</div>

<style>
  /* 定义浅色模式变量 */
  :root {
    --install-bg: #2c3e50;
    --install-text: #fff;
    --install-guide-bg: #f0f0f0;
    --install-guide-text: #333;
    --install-guide-border: #ddd;
    --modal-bg: #fff;
    --modal-text: #333;
    --modal-title: #2c3e50;
    --modal-subtitle: #34495e;
  }

  /* 深色模式变量覆盖 */
  @media (prefers-color-scheme: dark) {
    :root {
      --install-bg: #1e2a38;
      --install-text: #e0e0e0;
      --install-guide-bg: #3a3a3a;
      --install-guide-text: #e0e0e0;
      --install-guide-border: #555;
      --modal-bg: #2c3e50;
      --modal-text: #fff;
      --modal-title: #fff;
      --modal-subtitle: #ccc;
    }
  }
</style>

<script>
  // 存储安装事件
  let deferredPrompt;
  let installAttempts = 0;
  const MAX_INSTALL_ATTEMPTS = 3;
  
  const installPrompt = document.getElementById('installPrompt');
  const installBtn = document.getElementById('installBtn');
  const closeInstallBtn = document.getElementById('closeInstallBtn');

  // 检测是否在PWA模式下运行
  function isPwaMode() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone ||
           document.referrer.includes('android-app://') ||
           (window.navigator).standalone === true;
  }

  // 检查是否已经安装
  window.addEventListener('DOMContentLoaded', () => {
    // 如果是在独立模式下运行，隐藏安装提示
    if (isPwaMode()) {
      // 找到Safari安装指南并隐藏它
      const safariGuide = document.querySelector('.safari-install-guide');
      if (safariGuide) {
        safariGuide.style.display = 'none';
      }
    }
    
    // 处理快捷方式URL参数
    handleShortcuts();
  });

  // 监听beforeinstallprompt事件
  window.addEventListener('beforeinstallprompt', (e) => {
    console.log('捕获到安装提示事件');
    // 阻止Chrome自动显示安装提示
    e.preventDefault();
    // 存储事件以便稍后触发
    deferredPrompt = e;
    // 显示自定义安装按钮
    installPrompt.style.display = 'block';
  });

  // 点击安装按钮
  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) {
      console.log('安装提示不可用，请参考安装指南手动安装');

      return;
    }
    
    console.log('触发安装提示');
    
    try {
      // 显示安装提示
      deferredPrompt.prompt();
      // 等待用户响应
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`用户${outcome === 'accepted' ? '接受' : '拒绝'}了安装`);
      
      // 无论结果如何，重置deferredPrompt变量
      deferredPrompt = null;
      // 隐藏提示
      installPrompt.style.display = 'none';
      
      if (outcome === 'accepted') {
        console.log('PWA已成功安装');
      } else {
        // 用户拒绝后增加尝试计数
        installAttempts++;
        if (installAttempts < MAX_INSTALL_ATTEMPTS) {
          // 稍后再次尝试显示安装提示
          setTimeout(() => {
            installPrompt.style.display = 'block';
          }, 10000); // 10秒后重试
        }
      }
    } catch (error) {
      console.error('安装提示失败:', error);

    }
  });

  // 关闭提示
  closeInstallBtn.addEventListener('click', () => {
    installPrompt.style.display = 'none';
    installAttempts++;
    
    if (installAttempts < MAX_INSTALL_ATTEMPTS) {
      setTimeout(() => {
        installPrompt.style.display = 'block';
      }, 20000); // 20秒后重试
    }
  });



  // 检查是否已经安装
  window.addEventListener('appinstalled', (evt) => {
    console.log('应用已安装');
    installPrompt.style.display = 'none';
  });

  // 检查是否可安装并显示提示
  function checkInstallability() {
    // 检查是否在独立模式下运行（已安装）
    if (isPwaMode()) {
      console.log('应用已在PWA模式下运行');
      installPrompt.style.display = 'none';
    }
  }
  
  // 监听页面可见性变化
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      checkInstallability();
    }
  });
  
  // 处理快捷方式URL参数
  function handleShortcuts() {
    const urlParams = new URLSearchParams(window.location.search);
    const app = urlParams.get('app');
    
    if (app === 'homemoney') {
      window.open('http://192.168.0.197:3010', '_blank');
    } else if (app === 'chrysorrhoe') {
      window.open('http://192.168.0.197:3100', '_blank');
    } else if (app === 'inventory') {
      window.open('http://192.168.0.197:5000', '_blank');
    }
  }

  // 增强的PWA安装检测逻辑
  function detectInstallState() {
    // 延迟检查是否可以触发安装提示
    setTimeout(() => {
      if (!isPwaMode() && !deferredPrompt) {
        console.log('Android Chrome可能需要用户交互才能显示安装提示');
      }
    }, 2000);
  }
  
  // 立即执行安装状态检测
  detectInstallState();
  
  // 注册Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      // 使用相对路径确保兼容性
      navigator.serviceWorker.register('./service-worker.js')
        .then(registration => {
          console.log('Service Worker 注册成功:', registration.scope);
          
          // 注册后立即检查安装状态
          checkInstallability();
          
          // 监听Service Worker更新
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('发现新版本，准备更新');
                // 可以在这里显示更新提示
              }
            });
          });
        })
        .catch(error => {
          console.error('Service Worker 注册失败:', error);
        });
        
      // 监听来自Service Worker的消息
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'CACHE_UPDATED') {
          console.log('缓存已更新，刷新页面以使用新版本');
          // 可以选择自动刷新或提示用户刷新
          // 为避免打断用户体验，这里先提示用户
          if (confirm('发现新版本，是否立即更新？')) {
            window.location.reload();
          }
        }
      });
      
      // 检查控制当前页面的Service Worker是否有更新
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        console.log('控制器已更改，刷新页面');
        // 可以选择自动刷新，但为了更好的用户体验，建议提示用户
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      });
    });
  } else {
    console.log('当前浏览器不支持Service Worker');
  }
</script>
